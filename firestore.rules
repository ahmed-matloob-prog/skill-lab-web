rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isTrainer() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'trainer';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Users collection
    match /users/{userId} {
      // Anyone authenticated can read their own user document
      allow read: if isOwner(userId);

      // Only admins can read all users
      allow list: if isAdmin();

      // Only admins can create new users
      allow create: if isAdmin();

      // Users can update their own profile (except role)
      allow update: if isOwner(userId) &&
                       request.resource.data.role == resource.data.role;

      // Admins can update any user
      allow update: if isAdmin();

      // Only admins can delete users
      allow delete: if isAdmin();
    }

    // Passwords collection (POC only - use Firebase Auth in production)
    match /passwords/{username} {
      // Nobody can read passwords directly
      allow read: if false;

      // Only admins can create/update passwords
      allow create, update: if isAdmin();

      // Only admins can delete passwords
      allow delete: if isAdmin();
    }

    // Students collection
    match /students/{studentId} {
      // All authenticated users can read students
      allow read: if isAuthenticated();

      // Only admins and trainers can create students
      allow create: if isAdmin() || isTrainer();

      // Only admins and trainers can update students
      allow update: if isAdmin() || isTrainer();

      // Only admins can delete students
      allow delete: if isAdmin();
    }

    // Groups collection
    match /groups/{groupId} {
      // All authenticated users can read groups
      allow read: if isAuthenticated();

      // Only admins can create groups
      allow create: if isAdmin();

      // Only admins can update groups
      allow update: if isAdmin();

      // Only admins can delete groups
      allow delete: if isAdmin();
    }

    // Attendance records
    match /attendance/{recordId} {
      // All authenticated users can read attendance
      allow read: if isAuthenticated();

      // Trainers and admins can create attendance records
      allow create: if isAdmin() || isTrainer();

      // Only the creator or admin can update attendance within 24 hours
      allow update: if (isAdmin() || isTrainer()) &&
                       request.time < resource.data.timestamp + duration.value(24, 'h');

      // Only admins can delete attendance records
      allow delete: if isAdmin();
    }

    // Assessment records
    match /assessments/{recordId} {
      // All authenticated users can read assessments
      allow read: if isAuthenticated();

      // Trainers and admins can create assessment records
      allow create: if isAdmin() || isTrainer();

      // Only the creator or admin can update assessments within 24 hours
      allow update: if (isAdmin() || isTrainer()) &&
                       request.time < resource.data.timestamp + duration.value(24, 'h');

      // Only admins can delete assessment records
      allow delete: if isAdmin();
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
